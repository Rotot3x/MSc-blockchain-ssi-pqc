FROM ghcr.io/openwallet-foundation/acapy:py3.12-1.3-lts

USER root

RUN apt-get update && apt-get install -y \
    build-essential cmake git ninja-build libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Install liboqs for testing
RUN git clone --depth=1 https://github.com/open-quantum-safe/liboqs.git /tmp/liboqs \
    && cmake -S /tmp/liboqs -B /tmp/liboqs/build \
        -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=/usr/local \
        -DOQS_ENABLE_KEM_KYBER=ON -DOQS_ENABLE_SIG_DILITHIUM=ON \
    && cmake --build /tmp/liboqs/build --parallel $(nproc) \
    && cmake --build /tmp/liboqs/build --target install \
    && ldconfig && rm -rf /tmp/liboqs

RUN pip install --no-cache-dir \
    liboqs-python>=0.12.0 pytest>=7.4.0 pytest-asyncio>=0.21.0

COPY ../pqcrypto_fm /usr/src/pqcrypto_fm
RUN pip install -e /usr/src/pqcrypto_fm

COPY tests/ /usr/src/tests/
WORKDIR /usr/src

USER $user

CMD ["pytest", "-v", "--tb=short", "/usr/src/tests/"]